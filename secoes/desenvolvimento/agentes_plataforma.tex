\section{Agentes da plataforma JADE}\label{sec:agentes_da_plataforma}

Essa seção é dedicada a explicar o fluxo do desenvolvimento dos agentes que habitam a plataforma JADE previamente propostos em \ref{sec:agentes-plataforma}. Tendo em vista que os agentes de gerência são extraídos dos \textit{plugins} do \textit{framework} criado por \citeonline{gabriel}, esta seção tem também como objetivo explicar a forma como essa extração foi feita e os respectivos elementos que transformaram-se em serviços do Cloudstack no processo. Além desses agentes, é apresentado também como foi implementado o sensoriamento do agente inspetor assim como a forma de atuação deste em face de sua característica administrativa em relação a plataforma JADE.

\subsection{Agente inspetor da plataforma}

O agente inspetor da plataforma tem a função de sensoriar o ambiente JADE e instanciar os agentes de acordo com a demanda da plataforma de orquestração. Para obter essas heurísticas, o inspetor faz uso da API do \textit{Apache Cloudstack}, autenticando-se com o as chaves passadas para seu ambiente pelo gerente da plataforma. Em posse dessas heurísticas, o agente inspetor está pronto para começar seu ciclo de sensoriamento e atuação sobre a plataforma multiagente.

Para que seja possível sensoriar os agentes da plataforma e atuar na sua construção e destruição, o agente inspetor usa métodos de biblioteca disponibilizados pelo JADE. As funções expostas são representações de ações dentro de uma ontologia de gerenciamento de agentes interna ao JADE. Estes métodos são acessíveis no formato de classes Java, os quais são usados dentro das rotinas de percepção e atuação do agente inspetor. Assim, a criação e destruição de agentes ocorre através de trocas de mensagens entre os agentes inspetor e o AMS do JADE, que é o responsável por registrar e excluir os agentes da plataforma JADE.

O agente inspetor deve perceber também a destruição e criação de novos \textit{containers} dentro da plataforma, uma vez que a saída de um nodo pode significar diretamente a perda de agentes no ecosistema e a criação de um novo \textit{container} significa que há mais locais onde um agente pode ser alocado. Dado essa necessidade, o agente inspetor é inscrito como interessado nas notificações geradas pelo \textit{microkernel} do JADE através do serviço \textit{AddressNotificationService}. Deste modo, ele é capaz de sensoriar a dinâmica dos nodos da plataforma para que possa agir de acordo com seus objetivos. Devido a presença do inspetor na plataforma e a tolerância a falhas que lhe é garantido, nenhum agente precisa ser instanciado diretamente pelo \textit{Apache Cloudstack} ou qualquer elemento exterior a plataforma JADE.

Quando o agente inspetor percebe que a plataforma SMA não está apta para receber mais agentes, este deve avisar a ferramenta de orquerstração para que esta crie mais \textit{containers} JADE. Esse processo é realizado através da API REST do \textit{Apache Cloudstack}, onde o agente inspetor invoca um método pedindo por mais recursos e não espera resposta. Quem trata essa chamada de API é o módulo \textit{autonomic mas management} anexado ao Cloudstack. Esta chamada notifica o gerente da plataforma SMA de que ele deve instanciar mais um \textit{container}. A criação deste nodo será então percebida pelo inspetor através do serviço \textit{AddressNotificationService}. Dessa forma, o agente inspetor pode sensoriar toda a plataforma multiagente e gerencia-la autonomamente, utilizando-se de interações com a ferramenta de orquestração apenas para alocar novos \textit{containers} e obter heurísticas.

\subsection{AGENTES DE GERÊNCIA}
Os agentes de gerência foram implementados na plataforma JADE utilizando a liguagem de programação Java. Para a realização das ações necessárias no ambiente de orquestração foi implementada uma API \textit{REST} que utiliza o módulo de serialização de objetos \textit{GSON} \cite{gsonsite} para facilitar a transmissão de objetos e dados do ambiente para a plataforma multiagente.

\subsubsection{Blackboard}
A implementação do \textit{blackboard} foi realizada através de um agente que contém uma lista de objetos \textit{JSON} que correspondem a \textit{clusters} do ambiente. O \textit{blackboard} possui dois comportamentos, sendo um deles para receber uma mensagem padrão \textit{Inform} vinda do agente de busca contendo um \textit{cluster}, e outro para fornecer uma das entradas do \textit{blackboard} para o agente diligente, ao receber uma mensagem padrão \textit{Request}.

O padrão \textit{Inform} implica que o agente remetente (invariavelmente o agente de busca nesse caso) tem certeza de que a preposição da mensagem é verdadeira (o \textit{cluster} necessita ser trabalhado) e encaminha essa informação ao \textit{blackboard}. Já o padrão \textit{Request} é uma ação de propósito geral para requisitar a realização de uma ação por outro agente, sendo essa ação a aquisição de uma entrada do \textit{blackboard}. Basta haver uma entrada disponível no \textit{blackboard} para que o agente responda com uma mensagem padrão \textit{Inform} contendo a primeira entrada disponível. Caso o \textit{blackboard} esteja vazio, uma mensagem padrão \textit{Refuse} é enviada em resposta.

Ao ser inicializado, o agente \textit{blackboard} é adicionado ao \textit{Directory Facilitator} da plataforma JADE (também conhecido como as \textit{yellow pages}), para que os outros agentes possam encaminhar e receber suas mensagens apenas consultando o diretório.

\subsubsection{Agente De Busca}
O agente de busca tem o propósito de buscar \textit{clusters} que necessitam ser trabalhados, e ordená-los para trabalho de acordo com as heurísticas do especificadas pelo administrador do ambiente. Para tal, foi definido um único comportamento, que de acordo com um tempo definido pelo usuário (um \textit{tick}), faz uma requisição para a \textit{API REST} extendida do \textit{Apache Cloudstack}, que retorna objetos \textit{GSON} correspondentes a \textit{clusters} que não foram trabalhados por um período de tempo (novamente definido pelo usuário da plataforma). Uma consulta é feita ao \textit{Directory Facilitator} para obter uma referência ao agente \textit{blackboard} e então estes objetos então são encaminhados, em ordem, ao \textit{blackboard} pela mensagem \textit{Inform} descrita anteriormente.

\subsubsection{Agente Diligente}
O agente diligente é responsável por aplicar as funções de gerência aos \textit{clusters} contidos no \textit{blackboard}. Foi definido um comportamento cíclico, que em um primeiro momento, obtém a referência ao agente \textit{blackboard} a partir do \textit{Directory Facilitator}. Uma vez estabelecida a referência, ele troca mensagens com o \textit{blackboard}, de forma a obter a entrada mais prioritária da lista de \textit{clusters} que necessitam trabalho. Uma vez adquirida a referência ao \textit{cluster}, solicita à \textit{API REST} extendida do \textit{Apache Cloudstack} uma lista contendo seus \textit{hosts}. Esta lista de \textit{hosts} por sua vez é submetida a outro processo de priorização a partir das heurísticas do administrador. O agente então itera sobre a lista ordenada de \textit{hosts}, solicitando à API as VMs dos \textit{hosts} menos prioritários, que deverão ser migradas para \textit{hosts} com maior prioridade, enquanto estes podem comportar a carga adicional. Ao final da migração, caso existam \textit{hosts} na lista que não estão sendo utilizados, são realizadas chamadas para a API solicitando o desligamento deles. Uma vez que todos os \textit{clusters} foram gerenciados, o agente volta a solicitar ao \textit{blackboard} se existe algum \textit{cluster} que precisa ser trabalhado.

\subsubsection{Agente De Ativação de Recursos}
O agente de alocação opera de forma independente dos outros agentes do sistema. Sua responsabilidade é tentar manter uma quantidade suficiente recursos ativos, garantindo uma certa margem de recursos livres em relação aos alocados. Essa margem será definida pelo usuário da plataforma de orquestração \textit{Apache CloudStack}. O único comportamento do agente de alocação é disparado de tempos em tempos, de acordo com um intervalo de verificação também estabelecido pelo usuário. São realizadas duas chamadas para a \textit{API REST} extendida do \textit{Apache Cloudstack}, uma para obter os recursos que estão sendo utilizados naquele momento, e outra para obter a quantidade de recursos total disponível no ambiente. Caso os recursos utilizados estejam acima da margem de segurança, é efetuada uma nova chamada para obter os \textit{hosts} disponíveis para inicialização. A prioridade destes \textit{hosts} é então determinada pelo agente de acordo com as heurísticas do usuário para serem inicializados. O agente então solicita a inicialização destes \textit{hosts} em ordem até que a margem de segurança estabelecida seja cumprida.

\subsubsection{API REST}
Para realizar operações no ambiente de CN, foi necessário extender a API REST do \textit{Apache CloudStack} de modo a expor funções e objetos da plataforma de orquestração. As funções implementadas foram as seguintes:

\begin{itemize}
  \item \textit{getClustersNeedingWork()}: monta uma lista com referências a \textit{clusters} que não foram trabalhados a um tempo maior ou igual ao intervalo de verificação;
  \item \textit{getHostsInCluster(Cluster)}: retorna uma lista com referências a \textit{hosts} pertencentes ao \textit{cluster} especificado;
  \item \textit{getVmsInHost(Host)}: retorna uma lista com referências a \textit{VMs} instanciadas no \textit{host} especificado;
  \item \textit{migrateVm(VmToMigrate, DestinationHost)}: realiza a migração de uma VM a um \textit{host} específico;
  \item \textit{shutDown(Host)}: efetua a desativação de um \textit{host};
  \item \textit{getCloudUsedResources()}: retorna uma \textit{String} composta pelos recuros utilizados pelo ambiente naquele momento;
  \item \textit{getCloudAvailableResources()}: retorna um objeto \textit{String} composta pelos recursos totais disponíveis no ambiente naquele isntante;
  \item \textit{getHostsAvailableToStart()}: monta uma lista com referências a \textit{hosts} que podem ser ativados;
  \item \textit{startHost(Host)}: ativa o \textit{host} especificado.
\end{itemize}
