\section{Agentes da plataforma JADE}\label{sec:agentes_da_plataforma}

Essa seção é dedicada a explicar o fluxo do desenvolvimento dos agentes que habitam a plataforma JADE préviamente propostos por esse trabalho. Tendo em vista que os agentes de gerência são extraídos dos \textit{plugins} do \textit{framework} criado por \citeonline{gabriel}, esta seção tem também como objetivo explicar a forma como essa extração foi feita e os respectivos elementos que transformaram-se em serviços do Cloudstack no processo. Além desses agentes, é explicado também como foi implementado o sensoriamento do agente inspetor assim como a forma de atuação deste em face de sua característica administrativa em relação a plataforma JADE.

\subsection{Agente inspetor da plataforma}

%TODO

\subsection{AGENTES DE GERÊNCIA}
Os agentes de gerência foram implementados na plataforma JADE, utilizando a liguagem de programação Java. Para a realização das ações necessárias no ambiente de orquestração, foi implementada uma API \textit{REST} que utiliza o módulo de serialização de objetos \textit{GSON} para viabilizar a transmissão de objetos e dados do ambiente para a plataforma multiagente.

\subsubsection{BLACKBOARD}
A implementação do \textit{blackboard} foi realizada através de um agente que contém uma lista de \textit{Strings} que correspondem a \textit{clusters} do ambiente. O \textit{blackboard} possui dois comportamentos, sendo um deles para receber uma mensagem vinda do agente de busca contendo um \textit{cluster}, e outro para fornecer uma das entradas do \textit{blackboard} para o agente diligente. Ao ser inicializado, o agente \textit{blackboard} é adicionado ao \textit{Directory Facilitator} da plataforma JADE (também conhecido como as \textit{yellow pages}), para que os outros agentes possam encaminhar e receber suas mensagens apenas consultando o diretório.

\subsubsection{AGENTE DE BUSCA}
O agente de busca tem o único propósito de buscar \textit{clusters} que necessitam ser trabalhados. Para tal, foi definido um único comportamento, que de acordo com um tempo definido pelo usuário (um \textit{tick}), faz uma requisição para a API, que retorna objetos \textit{GSON} correspondentes a \textit{clusters} que não foram trabalhados por um período de tempo (novamente definido pelo usuário da plataforma). Estes objetos então são encaminhados ao \textit{blackboard}.

\subsubsection{AGENTE DILIGENTE}
O agente diligente é responsável por aplicar as funções de gerência aos \textit{clusters} contidos no \textit{blackboard}. Foi definido um comportamento cíclico, que em um primeiro momento troca mensagens com o \textit{blackboard}, para adquirir a lista de \textit{clusters} que necessitam trabalho. Uma vez que todas as entradas do \textit{blackboard} foram adquiridas, essa lista de \textit{clusters} é feita uma chamada à API para que os \textit{clusters} listados sejam ordenados para trabalho de acordo com as prioridades estabelecidas pelas heurísticas do usuário. Com os \textit{clusters} ordenados, o agente diligete itera sobre a lista, solicitando à API, para cada \textit{cluster}, uma lista contendo seus \textit{hosts}. Esta lista de \textit{hosts} por sua vez é submetida ao mesmo processo de priorização a partir das heurísticas do usuário. O agente então itera sobre a lista ordenada de \textit{hosts}, solicitando à API as VMs dos \textit{hosts} menos prioritários, que deverão ser migradas para \textit{hosts} com maior prioridade, enquanto estes podem comportar a carga adicional. Ao final da migração, caso existam \textit{hosts} na lista que não estão sendo utilizados, são realizadas chamadas para a API solicitando o desligamento deles. O processo é repetido para todos os \textit{clusters} adquiridos do \textit{blackboard}. Uma vez que todos os \textit{clusters} foram gerenciados, o agente volta a solicitar ao \textit{blackboard} se existem novos \textit{clusters} que precisam ser trabalhados.

\subsubsection{AGENTE DE ALOCAÇÃO}
O agente de alocação opera de forma independente dos outros agentes do sistema. Sua responsabilidade é tentar manter uma quantidade suficiente recursos ativos, garantindo uma certa margem de recursos livres em relação aos alocados. Essa margem é também chamada de \textit{overprovision} e será definida pelo usuário da plataforma. O único comportamento do agente diligente é disparado de tempos em tempos, de acordo com um intervalo de verificação também estabelecido pelo usuário. São realizadas duas chamadas para a API, uma para obter os recursos que estão sendo utilizados naquele momento, e outra para obter a quantidade de recursos total disponível no ambiente. Caso os recursos utilizados estejam acima da margem, são efetuadas novas chamadas para obter os \textit{hosts} disponíveis para inicialização, e a prioridade destes \textit{hosts} para serem inizializados de acordo com as heurísticas do usuário. A agente então solicita a inicialização destes \textit{hosts} em ordem até que o fator de \textit{overprovision} estabelecido seja cumprido.

\subsubsection{API REST}
Para realizar operações no ambiente de CN, foi necessário implementar uma API REST, que permita expor funções e objetos da plataforma de orquestração. As funções implementadas foram as seguintes:

\begin{itemize}
  \item \textit{getClustersNeedingWork()}: monta uma lista com referências a \textit{clusters} que não foram trabalhados a um tempo maior ou igual ao intervalo de verificação;
  \item \textit{getOrderedClusters(Clusters)}: aplica as heurísticas de prioridade de trabalho aos \textit{clusters}, retornando uma lista ordenada;
  \item \textit{getHostsInCluster(Cluster)}: retorna uma lista com referências a \textit{hosts} pertencentes ao \textit{cluster} especificado;
  \item \textit{getOrderedHosts(Hosts)}: aplica as heurísticas de prioridade aos \textit{hosts} especificados, retornando uma lista ordenada;
  \item \textit{getVmsInHost(Host)}: retorna uma lista com referências a \textit{VMs} instanciadas no \textit{host} especificado;
  \item \textit{mapAndMigrateVm(VmToMigrate, DestinationHost)}: realiza o mapeamento e a migração de uma VM a um \textit{host};
  \item \textit{canBeShutDown(Host)}: verifica a possibilidade de desligamento de um \textit{host}. Retorna \textit{true} caso seus recursos sejam dispensáveis ou \textit{false} se não forem;
  \item \textit{shutDown(Host)}: efetua a desativação de um \textit{host};
  \item \textit{getCloudUsedResources()}: retorna uma \textit{String} composta pelos recuros utilizados pelo ambiente naquele isntante;
  \item \textit{getCloudAvailableResources()}: retorna uma \textit{String} composta pelos recuros totais disponíveis no ambiente naquele isntante;
  \item \textit{getHostsAvailableToStart()}: monta uma lista com referências a \textit{hosts} que podem ser ativados;
  \item \textit{getRankedHostsAvailableToStart(Hosts)}: aplica as heurísticas de prioridade de inicialização aos \textit{hosts} especificados, retornando uma lista ordenada;
  \item \textit{startHost(Host)}: ativa o \textit{host} especificado.
\end{itemize}
